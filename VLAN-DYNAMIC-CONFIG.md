# Dynamic VLAN Configuration - Hardcoded Values Removed

## Summary of Changes

All hardcoded VLAN assignments have been removed from the FreeRADIUS configuration files. The system now relies **100% on the DOMAIN_CONFIG environment variable** for VLAN assignments.

## Files Modified

### 1. [configs/inner-tunnel](configs/inner-tunnel:247-256)

**Before (Hardcoded):**
```unlang
# --- BEGIN DYNAMIC DOMAIN CONFIG FOR INNER TUNNEL ---
if (&request:Tmp-String-0) {
    # krea.ac.in with key ".mba" = Student-MBA, VLAN 216
    if ((&request:Tmp-String-0 == "krea.ac.in") && (&User-Name =~ /.mba@/)) {
        update control {
            Tmp-String-1 := "Student-MBA"
        }
        update reply {
            Tunnel-Type := VLAN
            Tunnel-Medium-Type := IEEE-802
            Tunnel-Private-Group-Id := 216  # HARDCODED!
        }
        # ... repeated for SIAS (224), PhD (232), BBA (240), etc.
    }
}
# --- END DYNAMIC DOMAIN CONFIG FOR INNER TUNNEL ---
```

**After (Dynamic Template):**
```unlang
# --- BEGIN DYNAMIC DOMAIN CONFIG FOR INNER TUNNEL ---
# This section is DYNAMICALLY GENERATED by init.sh from DOMAIN_CONFIG environment variable
# DO NOT MANUALLY EDIT - All hardcoded VLANs have been removed
# The init.sh script will populate this section at container startup with:
#   - Domain-based VLAN assignments from DOMAIN_CONFIG
#   - User type classifications
#   - Key-based matching (e.g., .mba@, .sias@, etc.)
# Example DOMAIN_CONFIG format:
# [{"domain":"example.com","key":".mba","Type":"Student-MBA","VLAN":"216"}]
# --- END DYNAMIC DOMAIN CONFIG FOR INNER TUNNEL ---
```

## How It Works Now

### At Container Startup ([init.sh](init.sh))

1. **Parse DOMAIN_CONFIG** environment variable (JSON format)
   ```bash
   DOMAIN_CONFIG='[
     {"domain":"krea.ac.in","key":".mba","Type":"Student-MBA","VLAN":"216"},
     {"domain":"krea.ac.in","key":".sias","Type":"Student-SIAS","VLAN":"224"},
     {"domain":"krea.edu.in","Type":"Staff-Krea","VLAN":"248"}
   ]'
   ```

2. **Generate Dynamic VLAN Configuration**
   - Creates `/tmp/dynamic_vlan.conf` with if/elsif chains
   - Includes domain matching, key-based regex, and VLAN assignments
   - Uses `generate_vlan_attributes()` function to support multiple VLAN attribute types

3. **Inject into Config Files**
   - **inner-tunnel**: Replaces content between markers with generated config
   - **default**: Replaces content between markers with generated config
   - Adds `else` block to reject unsupported domains

### Generated Configuration Example

From DOMAIN_CONFIG above, `init.sh` generates:

```unlang
# krea.ac.in with key ".mba" = Student-MBA, VLAN 216
if ((&request:Tmp-String-0 == "krea.ac.in") && (&User-Name =~ /.mba@/)) {
    update control {
        Tmp-String-1 := "Student-MBA"
    }
    update reply {
        Tunnel-Type := VLAN
        Tunnel-Medium-Type := IEEE-802
        Tunnel-Private-Group-Id := 216
    }
    update session-state {
        Tunnel-Type := VLAN
        Tunnel-Medium-Type := IEEE-802
        Tunnel-Private-Group-Id := 216
        Tmp-String-1 := "Student-MBA"
    }
}
# krea.ac.in with key ".sias" = Student-SIAS, VLAN 224
elsif ((&request:Tmp-String-0 == "krea.ac.in") && (&User-Name =~ /.sias@/)) {
    # ... similar structure with VLAN 224
}
# krea.edu.in (default/others) = Staff-Krea, VLAN 248
elsif (&request:Tmp-String-0 == "krea.edu.in") {
    # ... similar structure with VLAN 248
}
else {
    # Domain not in configuration, reject
    update control {
        Auth-Type := Reject
        Error-Type := "invalid_domain"
    }
    update reply {
        Reply-Message := "Domain not supported"
    }
}
```

## DOMAIN_CONFIG Format

### Basic Format (Domain-Only)
```json
[
  {"domain":"example.com","Type":"Staff","VLAN":"10"},
  {"domain":"students.example.com","Type":"Student","VLAN":"20"}
]
```

### Advanced Format (With Key Matching)
```json
[
  {"domain":"example.com","key":".mba","Type":"Student-MBA","VLAN":"216"},
  {"domain":"example.com","key":".phd","Type":"Student-PhD","VLAN":"232"},
  {"domain":"example.com","Type":"Student-Others","VLAN":"144"}
]
```

### Field Descriptions

| Field | Required | Description | Example |
|-------|----------|-------------|---------|
| `domain` | ✅ Yes | Email domain to match | `"krea.ac.in"` |
| `key` | ❌ Optional | Username substring pattern | `".mba"` matches `user.mba@domain` |
| `Type` | ✅ Yes | User type classification | `"Student-MBA"`, `"Staff"` |
| `VLAN` | ✅ Yes | VLAN ID to assign | `"216"`, `"248"` |

### Key Matching Logic

- **With key**: Matches if `(domain == "example.com") AND (username contains key)`
  - Example: `{"domain":"krea.ac.in","key":".mba"}` matches `john.mba@krea.ac.in`

- **Without key**: Matches if `domain == "example.com"` (fallback/default)
  - Example: `{"domain":"krea.ac.in"}` matches any `*@krea.ac.in`

**Order matters!** Specific key-based rules should come **before** domain-only fallbacks:
```json
[
  {"domain":"example.com","key":".mba","Type":"MBA","VLAN":"100"},    // Checked first
  {"domain":"example.com","key":".phd","Type":"PhD","VLAN":"101"},    // Checked second
  {"domain":"example.com","Type":"Default","VLAN":"102"}              // Fallback (checked last)
]
```

## VLAN Attribute Support

The system supports multiple VLAN attribute types via the `VLAN_ATTRIBUTES` environment variable:

```bash
# Default (standard RADIUS)
VLAN_ATTRIBUTES="Tunnel-Private-Group-ID"

# Aruba APs
VLAN_ATTRIBUTES="Tunnel-Private-Group-ID,Aruba-User-VLAN"

# Cisco
VLAN_ATTRIBUTES="Tunnel-Private-Group-ID,Cisco-AVPair"

# Multiple attributes
VLAN_ATTRIBUTES="Tunnel-Private-Group-ID,Aruba-User-VLAN,Aruba-Named-User-VLAN"
```

Supported attributes:
- `Tunnel-Private-Group-ID` (standard, sent as INTEGER for AOS10 compatibility)
- `Aruba-User-VLAN` (Aruba-specific)
- `Aruba-Named-User-VLAN` (Aruba-specific, string format)
- `Cisco-AVPair` (Cisco-specific)

## Verification Steps

### 1. Check Generated Configuration

After container startup, verify the dynamic config was applied:

```bash
# View the generated inner-tunnel config
docker exec freeradius cat /etc/freeradius/sites-available/inner-tunnel | \
  grep -A 50 "BEGIN DYNAMIC DOMAIN CONFIG FOR INNER TUNNEL"

# View the generated default config
docker exec freeradius cat /etc/freeradius/sites-available/default | \
  grep -A 50 "BEGIN DYNAMIC DOMAIN CONFIG"
```

### 2. Test VLAN Assignments

Test users from different domains and keys:

```bash
# Test MBA student (should get VLAN 216)
radtest user.mba@krea.ac.in password localhost 0 testing123

# Test SIAS student (should get VLAN 224)
radtest user.sias@krea.ac.in password localhost 0 testing123

# Test staff (should get VLAN 248)
radtest staff@krea.edu.in password localhost 0 testing123

# Check the response includes:
# Tunnel-Type = VLAN
# Tunnel-Medium-Type = IEEE-802
# Tunnel-Private-Group-Id = <expected VLAN>
```

### 3. Debug Mode

Check FreeRADIUS debug output:

```bash
# Run in debug mode
docker exec -it freeradius radiusd -X

# Look for:
# - "Tmp-String-0 := '<domain>'"
# - "Tunnel-Private-Group-Id := <VLAN>"
# - "Tmp-String-1 := '<UserType>'"
```

## Troubleshooting

### Issue: VLANs Not Assigned

**Check 1**: Verify DOMAIN_CONFIG is set correctly
```bash
docker exec freeradius env | grep DOMAIN_CONFIG
```

**Check 2**: Verify init.sh generated the config
```bash
docker logs freeradius | grep -i "dynamic.*vlan"
# Should see: "Dynamic domain VLAN configuration applied..."
```

**Check 3**: Check for syntax errors in DOMAIN_CONFIG
```bash
# Must be valid JSON array
echo "$DOMAIN_CONFIG" | jq .
```

### Issue: Wrong VLAN Assigned

**Check**: Review the order in DOMAIN_CONFIG
- Key-based matches should come **before** domain-only matches
- First match wins (if/elsif logic)

**Fix**: Reorder DOMAIN_CONFIG entries

### Issue: Config Not Updating

**Solution**: Restart the container to re-run init.sh
```bash
docker-compose restart freeradius
```

## Migration from Hardcoded Config

If you had hardcoded VLANs before, migrate them to DOMAIN_CONFIG:

### Old (Hardcoded in inner-tunnel)
```unlang
if ((&request:Tmp-String-0 == "krea.ac.in") && (&User-Name =~ /.mba@/)) {
    update reply {
        Tunnel-Private-Group-Id := 216
    }
}
```

### New (DOMAIN_CONFIG)
```json
{
  "domain": "krea.ac.in",
  "key": ".mba",
  "Type": "Student-MBA",
  "VLAN": "216"
}
```

## Benefits of Dynamic Configuration

✅ **No Code Changes**: Update VLANs by changing environment variable only
✅ **Version Control**: DOMAIN_CONFIG can be in `.env` or docker-compose.yml
✅ **Easy Testing**: Different VLANs for dev/staging/prod environments
✅ **Self-Documenting**: JSON format is readable and explicit
✅ **Validation**: Can validate JSON before deployment
✅ **Atomic Updates**: Restart container to apply all changes at once

## Example Deployment

### docker-compose.yml
```yaml
services:
  freeradius:
    environment:
      DOMAIN_CONFIG: |
        [
          {"domain":"krea.ac.in","key":".mba","Type":"Student-MBA","VLAN":"216"},
          {"domain":"krea.ac.in","key":".sias","Type":"Student-SIAS","VLAN":"224"},
          {"domain":"krea.ac.in","key":".phd","Type":"Student-PhD","VLAN":"232"},
          {"domain":"krea.ac.in","Type":"Student-Others","VLAN":"144"},
          {"domain":"krea.edu.in","Type":"Staff-Krea","VLAN":"248"},
          {"domain":"ifmr.ac.in","Type":"IFMR","VLAN":"250"}
        ]
      VLAN_ATTRIBUTES: "Tunnel-Private-Group-ID,Aruba-User-VLAN"
```

### .env file
```bash
DOMAIN_CONFIG='[{"domain":"example.com","Type":"Staff","VLAN":"10"}]'
VLAN_ATTRIBUTES='Tunnel-Private-Group-ID'
```

---

**Last Updated:** 2025-12-12
**Related Docs:** [OPTIMIZATION-SUMMARY.md](OPTIMIZATION-SUMMARY.md)
**Configuration Files:** configs/inner-tunnel, configs/default, init.sh
