services:
  freeradius:
    build:
      dockerfile: Dockerfile
      context: .
    container_name: freeradius-google-ldap
    env_file: .env
    # Resource limits for 2k-3k concurrent sessions
    # Industry standard for high-concurrency RADIUS: 8-16 CPU cores, 8-16GB RAM
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 8G
        reservations:
          cpus: '4.0'
          memory: 4G
    environment:
      # LDAP Configuration
      - LDAP_SERVER=${LDAP_SERVER}
      - LDAP_IDENTITY=${LDAP_IDENTITY}
      - LDAP_PASSWORD=${LDAP_PASSWORD}
      - LDAP_BASE_DN=${LDAP_BASE_DN}
      - LDAP_BIND_DN=${LDAP_BIND_DN}

      # Multi-Domain Configuration (JSON format)
      - DOMAIN_CONFIG=${DOMAIN_CONFIG}

      # RADIUS Configuration
      - RADIUS_SECRET=${RADIUS_SECRET}

      # Database Configuration
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_MAX_CONNECTIONS=${DB_MAX_CONNECTIONS:-100}

      # Performance Tuning for 2k-3k concurrent users
      - RADIUS_MAX_CONNECTIONS=${RADIUS_MAX_CONNECTIONS:-500}
      - LDAP_MAX_CONNECTIONS=${LDAP_MAX_CONNECTIONS:-100}

      # Caching Configuration (Industry standard: 600-900 seconds)
      - CACHE_TTL=${CACHE_TTL:-600}
      - ENABLE_LDAP_CACHE=${ENABLE_LDAP_CACHE:-yes}
      - ENABLE_AUTH_CACHE=${ENABLE_AUTH_CACHE:-yes}

      # Logging and Debugging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_SQL_TRACE=${ENABLE_SQL_TRACE:-no}
      - ENABLE_LDAP_DEBUG=${ENABLE_LDAP_DEBUG:-no}
      - LOG_AUTH_SUCCESS=${LOG_AUTH_SUCCESS:-yes}
      - LOG_AUTH_FAILURE=${LOG_AUTH_FAILURE:-yes}
      - LOG_PASSWORDS=${LOG_PASSWORDS:-no}
    volumes:
      - ./certs:/certs:ro
      - ./logs:/var/log/freeradius
    ports:
      - "0.0.0.0:${RADIUS_AUTH_PORT}:1812/udp"
      - "0.0.0.0:${RADIUS_ACCT_PORT}:1813/udp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ps aux | grep '[f]reeradius'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - radius-net

  mysql:
    image: mysql:8.0
    container_name: radius-mysql
    env_file: .env
    # Resource limits for high-performance database (2k-3k concurrent users)
    # Industry standard: 4-8 CPU cores, 4-8GB RAM for RADIUS accounting database
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 6G
        reservations:
          cpus: '4.0'
          memory: 4G
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - TZ=${MYSQL_TIMEZONE}
    ports:
      - "127.0.0.1:${MYSQL_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d:ro
      - ./mysql-conf:/etc/mysql/conf.d:ro
    # MySQL server configuration optimized for 2k-3k concurrent RADIUS sessions
    # Industry standard tuning for high-volume authentication workloads
    command: >
      --default-authentication-plugin=mysql_native_password
      --default-time-zone='${MYSQL_TIMEZONE_OFFSET}'
      --max-connections=1000
      --innodb-buffer-pool-size=2G
      --innodb-log-file-size=512M
      --innodb-flush-log-at-trx-commit=2
      --innodb-write-io-threads=16
      --innodb-read-io-threads=16
      --innodb-io-capacity=8000
      --innodb-io-capacity-max=16000
      --innodb-buffer-pool-instances=16
      --innodb-flush-method=O_DIRECT
      --innodb-log-buffer-size=128M
      --skip-name-resolve
      --skip-log-bin
      --performance-schema=OFF
      --table-open-cache=8000
      --table-open-cache-instances=16
      --thread-cache-size=200
      --sort-buffer-size=4M
      --read-buffer-size=2M
      --read-rnd-buffer-size=4M
      --join-buffer-size=4M
      --tmp-table-size=128M
      --max-heap-table-size=128M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - radius-net

  # =====================================================
  # Modern Web Dashboard (radius-gui)
  # =====================================================
  # New MVC-based dashboard with enhanced features:
  # - 14 comprehensive pages
  # - PDF & CSV report generation
  # - Role-based access control (3 tiers)
  # - Enhanced error tracking integration
  # - Bootstrap 5 responsive UI
  # =====================================================
  webapp:
    build:
      context: ./radius-gui
      dockerfile: Dockerfile
    container_name: radius-webapp
    env_file: .env
    environment:
      # Database configuration
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}

      # Application settings
      - APP_URL=${APP_URL:-http://localhost:8080}
      - APP_TIMEZONE=${APP_TIMEZONE:-Asia/Kolkata}
      - SESSION_SECURE=${SESSION_SECURE:-false}
      - SESSION_LIFETIME=${SESSION_LIFETIME:-7200}

      # Environment
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
    ports:
      - "0.0.0.0:${DASHBOARD_PORT}:80"
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - radius-net

  # =====================================================
  # Legacy Dashboard (DEPRECATED)
  # =====================================================
  # The old dashboard has been moved to:
  # archive/dashboard-legacy/
  #
  # To use the legacy dashboard temporarily:
  # 1. Uncomment the section below
  # 2. Change DASHBOARD_PORT to a different port (e.g., 8081)
  # 3. Run: docker-compose up -d dashboard-legacy
  #
  # NOTE: No support will be provided for the legacy dashboard.
  # Please migrate to the new webapp (radius-gui) above.
  # =====================================================

  # dashboard-legacy:
  #   build:
  #     context: ./archive/dashboard-legacy/dashboard
  #     dockerfile: Dockerfile
  #   container_name: radius-dashboard-legacy
  #   env_file: .env
  #   environment:
  #     - DB_HOST=${DB_HOST}
  #     - DB_PORT=${DB_PORT}
  #     - DB_NAME=${DB_NAME}
  #     - DB_USER=${DB_USER}
  #     - DB_PASSWORD=${DB_PASSWORD}
  #     - ADMIN_USERNAME=${ADMIN_USERNAME}
  #     - ADMIN_PASSWORD=${ADMIN_PASSWORD}
  #     - ADMIN_EMAIL=${ADMIN_EMAIL}
  #     - JWT_SECRET=${JWT_SECRET}
  #     - SESSION_COOKIE_SECURE=${SESSION_COOKIE_SECURE}
  #     - FORCE_PASSWORD_CHANGE=${FORCE_PASSWORD_CHANGE}
  #     - ADMIN_SESSION_TIMEOUT=${ADMIN_SESSION_TIMEOUT}
  #     - BCRYPT_ROUNDS=${BCRYPT_ROUNDS}
  #     - DOMAIN_CONFIG=${DOMAIN_CONFIG}
  #   ports:
  #     - "8081:80"
  #   depends_on:
  #     mysql:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   networks:
  #     - radius-net

  # phpMyAdmin removed for production security
  # Use direct MySQL client access or secure tunnel instead
  # Example: docker exec -it radius-mysql mysql -u radius -p

volumes:
  mysql_data:
    driver: local

networks:
  radius-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
